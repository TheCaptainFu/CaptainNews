name: Update News Feed

on:
  # Î¤ÏÎ­Ï‡ÎµÎ¹ ÎºÎ¬Î¸Îµ 5 Î»ÎµÏ€Ï„Î¬
  schedule:
    - cron: '*/5 * * * *'
  
  # Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ GitHub UI
  workflow_dispatch:
  
  # Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ® ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¼Î­ÏƒÏ‰ API
  repository_dispatch:
    types: [update-news]
  
  # Î¤ÏÎ­Ï‡ÎµÎ¹ ÏƒÎµ ÎºÎ¬Î¸Îµ push ÏƒÏ„Î¿ master (Î³Î¹Î± Î´Î¿ÎºÎ¹Î¼Î­Ï‚)
  push:
    branches:
      - master
    paths:
      - '.github/workflows/update_news.yml'

jobs:
  update-news:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Î£Î·Î¼Î±Î½Ï„Î¹ÎºÏŒ: ÎšÎ±Ï„ÎµÎ²Î¬Î¶ÎµÎ¹ ÏŒÎ»Î¿ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î³Î¹Î± Î½Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎºÎ¬Î½ÎµÎ¹ amend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run news aggregator
        run: node update-news.js
      
      - name: Configure git
        run: |
          git config --global user.name 'CaptainBot'
          git config --global user.email 'bot@captainnews.gr'
      
      - name: Commit and push if changed
        run: |
          git add news.json
          
          # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚ ÏƒÏ„Î¿ news.json
          if git diff --staged --quiet; then
            echo "No changes to news.json - skipping commit"
          else
            echo "Changes detected - updating news.json..."
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            # Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± ÎºÎ¬Î½ÎµÎ¹ amend Ï„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ commit. 
            # Î‘Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ (Ï€.Ï‡. ÏƒÏ„Î¿ Ï€ÏÏÏ„Î¿ Ï„ÏÎ­Î¾Î¹Î¼Î¿), ÎºÎ¬Î½ÎµÎ¹ ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒ commit.
            git commit --amend -m "ğŸ¤– Auto-update news feed - $TIMESTAMP" || git commit -m "ğŸ¤– Auto-update news feed - $TIMESTAMP"
            
            # Force push ÏƒÏ„Î¿ master Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹ ÎºÎ±Î¸Î±ÏÏŒ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ
            git push --force origin master
          fi